"use strict";!function(){window.RallyUI=function(t){this.rally=t;var e=this;$("#add-instruction").on("click",function(t){e.rally.addNextInstruction().then(function(t){e.selectInstruction(t)})}),$("#edit-instruction").on("click",function(t){e.editMode(!e.editState)}),$("#reset-instructions").on("click",function(t){e.rally.reset()}),$("#toggle-timer").on("click",function(t){e.toggleTimer()}),$(document).on("keydown",function(t){e.handleKeyDownGlobal(t)}),this.editBox("#edit-rally-speed",t.rallySpeed),this.editBox("#edit-odom-factor",t.odomFactor),this.editBox("#edit-clock-adj",t.clockAdj).on("focus",function(t){e.setTimerInterval(10)}).on("blur",function(t){e.setTimerInterval(100)}),this.editCheckbox("#edit-time-seconds",t.timeSeconds).on("change",function(){e.updateTimeFormats(),e.renderInstructions()}),e.updateTimeFormats(),e.createTimer(),e.editMode(!1),e.renderInstructionsHeader(),e.showColumn()},RallyUI.prototype={checkVal:function(t){return"undefined"==typeof t||null===t?"ERR":t},editState:!1,selected:null,columnState:{},timerBody:null,timerInterval:null,laps:null,modalActive:!1,menu_hidden_columns:{},showColumn:function(t,e){var n=this,r=function(t,e){e?($("th[data-col='"+t+"']").show(),$("td[data-col='"+t+"']").show()):($("th[data-col='"+t+"']").hide(),$("td[data-col='"+t+"']").hide()),$("label[data-col='"+t+"'] input").prop("checked",e),n.menu_hidden_columns[t].visible=!e};if(t){if("instr"==t)return;r(t,e),n.columnState[t]=e,n.rally.setConfig("column_state",JSON.stringify(this.columnState))}else{var i=n.rally.getConfig("column_state");try{i=JSON.parse(i)}catch(a){}i||(i={raw_mlg:!1,raw_d_mlg:!1,time:!1}),RallyInstruction.prototype.column_defs_display_order.forEach(function(t){i.hasOwnProperty(t.name)||(i[t.name]=!0),r(t.name,i[t.name])}),n.columnState=i}$("#instructions").trigger("resize")},renderInstructionsHeader:function(){var t=$("#instructions"),e=t.children("thead"),n=$("#hideshow"),r=this;e.children().remove(),n.children().remove();var i=$("<tr />");RallyInstruction.prototype.column_defs_display_order.forEach(function(t){var e=$("<th />").attr("data-col",t.name);e.addClass("instruction-column"),e.html(t.label),e.on("dblclick",function(e){r.showColumn(t.name,!1)}),i.append(e);var a=$("<input type=checkbox checked/>");a.on("change",function(e){r.showColumn(t.name,e.target.checked)}),n.append($("<label />").attr("data-col",t.name).append(a).append(t.label)),r.columnState[t.name]=!0,r.menu_hidden_columns[t.name]={name:t.label}}),e.append(i),$.contextMenu({selector:".instruction-column",callback:function(t,e){console.log(t),console.log(e);var n=t;return r.showColumn(n,!0),!0},build:function(){var t={hide:{name:"Hide",callback:function(t,e){var n=this.attr("data-col");return r.showColumn(n,!1),!0}},show:{name:"Show",items:r.menu_hidden_columns}};return{items:t}}});var a=function(t){return Number.parseFloat(t.attr("data-row"))};$.contextMenu({selector:"tr td",items:{insert_before:{name:"Insert before",callback:function(t,e){return r.insertInstruction(-.5),!0}},insert_after:{name:"Insert after",callback:function(t,e){return r.insertInstruction(.5),!0}},separator1:{type:"cm_seperator"},"delete":{name:"Delete",callback:function(t,e){var n=this.closest("tr"),i=a(n);return r.rally.deleteInstruction(r.rally.instruction(i)),!0}}}}),t.floatThead()},renderInstructions:function(){var t=$("#instructions").children("tbody");t.children().remove();var e=this;e.rally.instructions.forEach(function(t){e.renderInstruction(t)}),$("#instructions").trigger("resize")},renderInstruction:function(t){if(null!==t){var e=$("#instructions").children("tbody"),n=this,r=$("<tr />").attr("data-row",t.instr).attr("tabindex",0);t.columns.forEach(function(e){var i=$("<td />").attr("data-col",e.name),a=!e.isSet();a||i.addClass("notcalc");var o=e.value;if("delay"==e.name||"err_time"==e.name?0===o&&(o=""):"notes"==e.name?i.removeClass("notcalc"):"number"==typeof o&&("instr"==e.name?o=o.toFixed(1):"tod"==e.name?o=n.formatAbsTime(o):"d_time"==e.name?o=n.formatRelTime(o):"cas"!=e.name&&(o=o.toFixed(3))),n.editState&&n.isSelected(t.instr)&&!e.read_only){var l=$("<input />");l.attr("type","text"),l.attr("size",5),a?(l.attr("placeholder",o),l.attr("defaultValue","")):(l.val(o),l.attr("defaultValue",o)),l.on("keydown",function(e){n.handleKeyDownInput(e,t)}),l.on("blur",function(r){var i=null;if(l.val().length>0&&(i=l.val()),i!=e.stored_value)try{n.rally.setValue(t,e,i)}catch(a){n.alertDanger("Exception",a.message),l.val(l.attr("defaultValue"))}}),i.append(l),i.addClass("edit")}else i.html(o);"d_mlg"==e.name?.15>=o&&o>0&&i.addClass("danger"):"cas"==e.name&&o>0&&o!=n.rally.rallySpeed()&&i.addClass("warning"),r.append(i),n.columnState[e.name]||i.hide()}),r.on("click",function(e){n.isSelected(t.instr)||n.selectInstruction(t.instr,{row:t.instr,col:$(e.target).attr("data-col")})}),r.on("focus",function(e){n.isSelected(t.instr)||n.selectInstruction(t.instr)}),r.on("dblclick",function(e){n.editState||n.editMode(!0,{row:t.instr,col:$(e.target).attr("data-col")})}),r.on("keydown",function(e){n.handleKeyDownRow(e,t)});var i=e.children("tr[data-row='"+t.instr+"']");i.length>0?(r.insertBefore(i),i.remove()):e.append(r),n.isSelected(t.instr)&&(r.addClass("active"),n.editState?r.children("td[data-col="+n.selected.col+"]").children("input").focus().select():r.focus())}},handleKeyDownInput:function(t,e){var n,r,i=this,a=$(t.target),o=Number.parseFloat(a.closest("td").attr("data-col")),l=!0;if(!i.modalActive){switch(t.keyCode){case 33:for(n=e,r=5;r>0;r--)n.prev&&(n=n.prev);n!=e&&(a.trigger("blur"),i.selectInstruction(n.instr,{row:n.instr,col:o}));break;case 34:for(n=e,r=5;r>0;r--)n.next&&(n=n.next);n!=e&&(a.trigger("blur"),i.selectInstruction(n.instr,{row:n.instr,col:o}));break;case 38:e.prev&&(a.trigger("blur"),i.selectInstruction(e.prev.instr,{row:e.prev.instr,col:o}));break;case 13:case 40:var s=e.next;a.trigger("blur"),s?i.selectInstruction(e.next.instr,{row:e.next.instr,col:o}):i.rally.addNextInstruction().then(function(t){i.selectInstruction(t,{row:t,col:o})});break;case 27:i.editMode(!1);break;case 46:t.shiftKey?(e.next?i.selectInstruction(e.next.instr,{row:e.next.instr,col:o}):e.prev&&i.selectInstruction(e.prev.instr,{row:e.prev.instr,col:o}),i.rally.deleteInstruction(e.id)):l=!1;break;default:l=!1}l&&(t.stopPropagation(),t.preventDefault())}},handleKeyDownRow:function(t,e){var n,r,i=this,a=!0;if(!i.modalActive){switch(t.keyCode){case 33:for(n=e,r=5;r>0;r--)n.prev&&(n=n.prev);n!=e&&i.selectInstruction(n.instr,{row:n.instr,col:index});break;case 34:for(n=e,r=5;r>0;r--)n.next&&(n=n.next);n!=e&&i.selectInstruction(n.instr,{row:n.instr,col:index});break;case 38:e.prev&&i.selectInstruction(e.prev.instr);break;case 40:e.next;e.next&&i.selectInstruction(e.next.instr);break;default:a=!1}a&&(t.stopPropagation(),t.preventDefault())}},handleKeyDownGlobal:function(t,e){var n=this,r=!1;if(!n.modalActive){try{switch(t.keyCode){case 113:n.editMode(!n.editState);break;case 76:n.timerLap();break;case 67:t.shiftKey&&n.timerResetLaps();break;case 109:n.insertInstruction(t.shiftKey?-1:-.5);break;case 107:n.insertInstruction(t.shiftKey?1:.5);break;default:r=!1}}catch(i){n.alertException(i)}r&&(t.stopPropagation(),t.preventDefault())}},findRow:function(t){return $("tr[data-row='"+t+"']")},findCell:function(t,e){return $("tr[data-row='"+t+"']").children("td[data-col='"+e+"']")},isSelected:function(t){return null!==this.selected&&this.selected.row==t},selectInstruction:function(t,e){$("tr.active").removeClass("active");var n=this.selected;if(t=Number.parseFloat(t),isNaN(t)&&(t=null),e&&(e.row=Number.parseFloat(e.row),e.col=Number.parseInt(e.col)),null!==n){var r=$("tr[data-row='"+n.row+"']");r.find("input").trigger("blur")}if(null!==t){e?this.selected=e:this.selected={row:t,col:0},this.renderInstruction(this.rally.instruction(t)),null!==n&&this.renderInstruction(this.rally.instruction(n.row));var i=$("tr[data-row='"+t+"']");if(this.editState&&e){var a=this.findCell(e.row,e.col),o=a.find("input");o.focus(),o.select()}i.addClass("active")}},editMode:function(t,e){if("undefined"!=typeof t&&(this.editState=t),null!==this.selected&&(this.renderInstruction(this.rally.instruction(this.selected.row)),this.editState&&e)){var n=(this.findRow(e.row),this.findCell(e.row,e.col)),r=n.find("input");r.focus(),r.select()}var i=$("#edit-instruction");t?i.addClass("active"):i.removeClass("active")},editBox:function(t,e){var n=this;return t=$(t),e=e.bind(n.rally),t.on("blur",function(r){e(t.val()),n.renderInstructions()}),t.val(e()),t},editCheckbox:function(t,e){var n=this;return t=$(t),e=e.bind(n.rally),t.on("change",function(r){e(t.is(":checked")),n.renderInstructions()}),t.prop("checked",e()),t},createTimer:function(){var t=this,e=$("body"),n=$("#timer-panel");this.timerBody=$("#timer-value"),n.css("position","fixed"),t.ensureTimerVisible(),n.draggable({handle:".move-grip",containment:e,scroll:!1,delay:100,stop:function(e,n){t.timerPosition(n.position)}});var r=null;n.on("mousedown",function(){r=setTimeout(function(){n.addClass("ui-draggable-dragging")},100)}),n.on("mouseup",function(){n.removeClass("ui-draggable-dragging"),clearTimeout(r)}),this.setTimerInterval(100),this.laps=$("#timer-laps"),$("#timer-lap").on("click",function(){t.timerLap()}),$("#timer-clear").on("click",function(){t.timerResetLaps()}),"true"==t.rally.getConfig("timer_visible")&&(n.addClass("in"),$("#toggle-timer").addClass("active"))},setTimerInterval:function(t){this.timerInterval&&clearInterval(this.timerInterval),t>0&&(this.timerInterval=setInterval(this.updateTimer.bind(this),t))},updateTimer:function(){if(this.timerBody){var t=this.timerBody.text(),e=this.formatTimer(this.rally.now());t!=e&&this.timerBody.text(e)}},timerPosition:function(t){arguments.length>0&&this.rally.setConfig("timer_position",JSON.stringify(t));try{t=JSON.parse(this.rally.getConfig("timer_position"))}catch(e){if("SyntaxError"!=e.name)throw e;t=null}return null===t&&(t={top:0,left:0}),t},updateTimeFormats:function(){if(this.rally.timeSeconds())this.formatTimer=function(t){return moment(t).format("HH:mm:ss.S")},this.formatAbsTime=function(t){return moment(t).format("HH:mm:ss")},this.formatRelTime=function(t){return t>0?moment(1e3*t).format("m:ss"):"0:00"};else{var t=function(t,e){var n=moment(t),r=parseFloat(moment.duration({seconds:n.second(),milliseconds:n.milliseconds()}).asMinutes()),i=n.format(e)+String(r.toFixed(3)).substr(1);return i};this.formatTimer=function(e){return t(e,"HH:mm")},this.formatAbsTime=function(e){return t(e,"HH:mm")},this.formatRelTime=function(e){return e>0?t(1e3*e,"m"):"0:00"}}},timerLap:function(){this.laps.append($("<li />").text(this.formatTimer(this.rally.now())))},timerResetLaps:function(){this.laps.children().remove()},ensureTimerVisible:function(){var t=this,e=$("body"),n=$("#timer-panel"),r=t.timerPosition();r.left+n.width()>e.width()&&(r.left=e.width()-n.width()),r.top+n.height()>e.height()&&(r.top=e.height()-n.height()),t.timerPosition(r),n.css(r)},toggleTimer:function(){var t=$("#toggle-timer"),e=$("#timer-panel"),n=this,r=!e.hasClass("in");r?(n.ensureTimerVisible(),t.addClass("active"),n.setTimerInterval(100),e.addClass("in")):(t.removeClass("active"),n.setTimerInterval(0),e.removeClass("in")),n.rally.setConfig("timer_visible",JSON.stringify(r))},alertDanger:function(t,e){var n=this,r=$("#alert"),i=r.find(".modal-header");i.addClass("alert-danger"),r.find(".modal-title").text(t),r.find(".modal-body").text(e),r.on("hidden.bs.modal",function(t){i.removeClass("alert-danger"),r.unbind("hidden.bs.modal"),n.modalActive=!1}),n.modalActive=!0,r.modal()},alertException:function(t){this.alertDanger("Exception",t.message)},insertInstruction:function(t){var e=this;if(e.selected){var n=e.rally.instruction(e.selected.row);e.rally.addInstruction(n.instr.value+t).then(function(t){e.selectInstruction(t)})}}}}(),function(){window.Rally=function(){this.init(),this.ui=new RallyUI(this)},Rally.prototype={instructions:[],instruction_map:new Map,instruction_id_map:new Map,last_instr:null,init:function(){var t=this.db=new Dexie("MyDatabase");t.version(1).stores({instructions:["id++","&instr","raw_mlg","cas","delay","mlg","time","notes"].join()}),t.open()["catch"](function(t){alert("Uh oh : "+t)}),this.last_instr=0,this.calculate(),this.cachedClockAdj=this.clockAdj()},cachedClockAdj:0,now:function(){return Date.now()+this.cachedClockAdj},calculate:function(){var t=this,e=null;return this.instruction_map.clear(),this.instruction_id_map.clear(),this.db.instructions.toArray(function(n){t.instructions=n.sort(function(t,e){return t.instr-e.instr}).map(function(n){var r=new RallyInstruction(n);return r.calculate(t,e),t.instruction_map.set(parseFloat(r.instr),r),t.instruction_id_map.set(r.id,r),t.last_instr=r.instr.value,r.prev=e,e&&(e.next=r),e=r,r}),t.ui.renderInstructions()})},instruction:function(t){return t=parseFloat(t),this.instruction_map.has(t)?this.instruction_map.get(t):null},addInstruction:function(){var t={};if(t.instr=Number.parseFloat(arguments[0]),this.instruction_map.has(t.instr))throw new Error("Instruction numbers must be unique");switch(t.raw_mlg=null,t.cas=null,t.delay=null,t.mlg=null,t.time=null,arguments.length){case 6:t.time=Number.parseInt(arguments[5]);case 5:t.mlg=Number.parseFloat(arguments[4]);case 4:t.delay=Number.parseFloat(arguments[3]);case 3:t.cas=Number.parseInt(arguments[2]);case 2:t.raw_mlg=Number.parseFloat(arguments[1])}var e=this;return this.db.instructions.put(t).then(function(){return e.calculate().then(function(){return t.instr})})},addNextInstruction:function(){return this.last_instr=Math.floor(this.last_instr+1),this.addInstruction(this.last_instr)},setValue:function(t,e,n){var r=this,i={};"instr"==e.name?n=r.parseInstruction(e.format_cb(n)):"tod"==e.name?n=r.parseTime(n):e.format_cb&&(n=e.format_cb(n)),i[e.name]=n,this.db.instructions.update(t.id,i).then(function(){r.calculate()})["catch"](function(t){console.log(instr),console.log(i)})},deleteInstruction:function(t){var e=this;t&&this.last_instr==t.instr.value&&(t.prev?this.last_instr=t.prev.instr.value:this.last_instr=0),e.db.instructions.where("id").equals(t.id)["delete"]().then(function(){e.calculate()})},odomFactor:function(t){return arguments.length>0&&this.setConfig("odom_factor",t),t=this.getConfig("odom_factor"),null===t&&(t=1),Number.parseFloat(t)},casFactor:function(t){return arguments.length>0&&this.setConfig("cas_factor",t),t=this.getConfig("cas_factor"),null===t&&(t=1),Number.parseFloat(t)},rallySpeed:function(t){return arguments.length>0&&this.setConfig("rally_speed",t),t=this.getConfig("rally_speed"),null===t&&(t=1),Number.parseInt(t)},clockAdj:function(t){return arguments.length>0&&(this.setConfig("clock_adj",t),this.cachedClockAdj=this.clockAdj()),t=this.getConfig("clock_adj"),null===t&&(t=0),Number.parseInt(t)},timeSeconds:function(t){return arguments.length>0&&this.setConfig("time_seconds",Boolean(t)),t=this.getConfig("time_seconds"),t=null===t?!0:"true"==t.toLowerCase(),Boolean(t)},adjustMilleage:function(t){return Number.parseFloat(t)*this.odomFactor()},adjustCAS:function(t){return Number.parseFloat(t)*this.casFactor()},getConfig:function(t){return window.localStorage.getItem(t)},setConfig:function(t,e){return window.localStorage.setItem(t,e)},reset:function(){this.db["delete"](),this.init()},parseInstruction:function(t){if(null===t||isNaN(t))throw new Error("Invalid format for instruction");if(this.instruction_map.has(t))throw new Error("Instruction numbers must be unique");return t},parseTime:function(t){var e=null;if(null!==t){if(!t.match(/^\s*[0-9:.]+(\s*[pamPAM]+)?\s*$/))throw new Error("Invalid time format");if(this.timeSeconds())e=moment(t,["h-m-s","h-m","H-m A"]);else if("string"==typeof t&&t.includes(".")){var n=null;if(n=t.match(/^\s*(([0-9]+):)?([0-9]+)\.([0-9]+)(\s*[pamPAM]+)?\s*$/),!n)throw new Error("Invalid time format");e=moment({h:n[2],m:n[3]}),e.add(60*Number.parseFloat("0."+n[4]),"seconds")}else e=moment(t,["h-m-s","h-m","H-m A"]);e=e.isValid()?e.valueOf():null}return e}},window.RallyInstruction=function(t){this.id=t.id,this.columns=[],this.columns_calc_order=[];var e=this;this.column_defs_display_order.forEach(function(n){var r=null;t.hasOwnProperty(n.name)&&(r=t[n.name]);var i=new RallyInstructionColumn(r,n);e.columns.push(i),Object.defineProperty(e,i.name,{get:function(){return i}})}),this.column_defs_calc_order.forEach(function(t){e.columns_calc_order.push(e[t])})},RallyInstruction.prototype={column_defs_display_order:[],column_defs_by_name:{},column_defs_calc_order:[],parseFixedFloat:function(t){return function(e){var n=Number.parseFloat(e);return n=isNaN(n)?null:n.toFixed(t)}},parseFloat:function(t){var e=Number.parseFloat(t);return isNaN(e)&&(e=null),e},parseInt:function(t){var e=Number.parseInt(t);return isNaN(e)&&(e=null),e},calculate:function(t,e){var n=this;this.columns_calc_order.forEach(function(r){r.calc(t,e,n)})}},window.RallyInstructionColumn=function(t,e){this.name=e.name,this.label=e.label,this.default_value=e.default_value,this.format_cb=e.format_cb,this.calc_if_prev_cb=e.calc_if_prev_cb,this.calc_always_cb=e.calc_always_cb,this.read_only=!!e.read_only,this.calculated_value=t,this.stored_value=t,Object.defineProperty(this,"value",{get:function(){return null!==this.stored_value?this.stored_value:this.calculated_value}})},RallyInstructionColumn.prototype={calc:function(t,e,n){var r=null;r=this.isSet()?this.value:this.calc_always_cb?this.calc_always_cb.apply(this,arguments):e&&this.calc_if_prev_cb?this.calc_if_prev_cb.apply(this,arguments):this.default_value,this.calculated_value=r},isSet:function(){return null!==this.stored_value},toString:function(){var t=this.value;return this.format_cb&&(t=this.format_cb(t)),t}},RallyInstruction.prototype.column_defs_display_order=[{name:"instr",label:"Instr",format_cb:RallyInstruction.prototype.parseFixedFloat(1)},{name:"raw_mlg",label:"Raw Mlg",default_value:0,format_cb:RallyInstruction.prototype.parseFloat,calc_if_prev_cb:function(t,e,n){return n.mlg.isSet()&&!n.raw_mlg.isSet()?e.raw_mlg.value+(n.mlg.value-e.mlg.value):0}},{name:"raw_d_mlg",label:"Raw &Delta;Mlg",read_only:!0,default_value:0,format_cb:RallyInstruction.prototype.parseFloat,calc_if_prev_cb:function(t,e,n){var r=n.raw_mlg.value-e.raw_mlg.value;return 0>r?0:r}},{name:"mlg",label:"Mlg",default_value:0,format_cb:RallyInstruction.prototype.parseFloat,calc_if_prev_cb:function(t,e,n){return 0===n.raw_mlg.value?0:e.mlg.value+n.d_mlg.value}},{name:"d_mlg",label:"&Delta;Mlg",read_only:!0,default_value:0,format_cb:RallyInstruction.prototype.parseFloat,calc_always_cb:function(t,e,n){return t.adjustMilleage(n.raw_d_mlg.value)}},{name:"cas",label:"CAS",default_value:0,format_cb:RallyInstruction.prototype.parseInt,calc_if_prev_cb:function(t,e,n){return e.cas.value}},{name:"delay",label:"Delay",default_value:0,format_cb:RallyInstruction.prototype.parseFloat},{name:"tod",label:"TOD",format_cb:RallyInstruction.prototype.parseInt,calc_if_prev_cb:function(t,e,n){var r=e.tod.value;return r+=1e3*(n.d_time.value+e.err_time.value)}},{name:"time",label:"Time",default_value:0,read_only:!0,format_cb:RallyInstruction.prototype.parseInt,calc_if_prev_cb:function(t,e,n){return e.time.value+n.d_time.value}},{name:"d_time",label:"&Delta;Time",default_value:0,read_only:!0,format_cb:RallyInstruction.prototype.parseFloat,calc_if_prev_cb:function(t,e,n){var r=3600*n.raw_d_mlg.value;return r/=e.cas.value,r+=n.delay}},{name:"err_time",label:"Err Time",default_value:0,read_only:!0,format_cb:RallyInstruction.prototype.parseFloat,calc_if_prev_cb:function(t,e,n){var r=0;return n.tod.isSet()&&(r=e.tod.value-n.tod.value,r/=1e3,r+=n.d_time.value+e.err_time.value),r}},{name:"notes",label:"Notes"}],RallyInstruction.prototype.column_defs_display_order.forEach(function(t){RallyInstruction.prototype.column_defs_by_name[t.name]=t}),RallyInstruction.prototype.column_defs_calc_order=["instr","raw_d_mlg","d_mlg","mlg","cas","d_time","time","tod","raw_mlg","err_time"]}();